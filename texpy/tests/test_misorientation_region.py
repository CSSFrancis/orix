import pytest
import numpy as np

from texpy.quaternion.symmetry import Symmetry
from texpy.quaternion.orientation_region import MisorientationRegion
from texpy.quaternion.rotation import Rotation

pair1 = ('432', '2')
n1 = np.array([
    [ 0.     , -1.     ,  0.     ,  0.     ],
    [ 0.38268,  0.     , -0.92388, -0.     ],
    [ 0.38268, -0.     , -0.     , -0.92388],
    [ 0.38268,  0.     ,  0.     ,  0.92388],
    [ 0.38268, -0.     ,  0.92388,  0.     ],
    [ 0.38268,  0.92388,  0.     , -0.     ],
    [ 0.5    ,  0.5    , -0.5    , -0.5    ],
    [ 0.5    ,  0.5    , -0.5    ,  0.5    ],
    [ 0.5    ,  0.5    ,  0.5    , -0.5    ],
    [ 0.5    ,  0.5    ,  0.5    ,  0.5    ]
])
v1 = np.array([
    [-0.8629, -0.    , -0.3574,  0.3574],
    [-0.8629, -0.    ,  0.3574,  0.3574],
    [-0.8536,  0.1464, -0.3536, -0.3536],
    [-0.8536,  0.1464,  0.3536, -0.3536],
    [-0.8536,  0.3536, -0.3536, -0.1464],
    [-0.8536,  0.3536, -0.1464,  0.3536],
    [-0.8536,  0.3536,  0.1464, -0.3536],
    [-0.8536,  0.3536,  0.3536,  0.1464],
    [ 0.8536, -0.3536, -0.3536,  0.1464],
    [ 0.8536, -0.3536, -0.1464, -0.3536],
    [ 0.8536, -0.3536,  0.1464,  0.3536],
    [ 0.8536, -0.3536,  0.3536, -0.1464],
    [ 0.8536, -0.1464, -0.3536, -0.3536],
    [ 0.8536, -0.1464,  0.3536, -0.3536],
    [ 0.8629,  0.    , -0.3574,  0.3574],
    [ 0.8629,  0.    ,  0.3574,  0.3574],
])

pair2 = ('4/mmm', '2/m')
n2 = np.array([
    [ 0.     , -1.     ,  0.     ,  0.     ],
    [ 0.     ,  0.     ,  0.     ,  1.     ],
    [ 0.38268, -0.     , -0.     , -0.92388],
    [ 0.70711,  0.     , -0.70711,  0.     ],
    [ 0.70711, -0.     ,  0.70711, -0.     ],
    [ 0.70711,  0.5    , -0.5    ,  0.     ],
    [ 0.70711,  0.5    ,  0.5    , -0.     ],
    [ 0.70711,  0.70711,  0.     ,  0.     ]
])
v2 = np.array([
    [-0.7071, -0.    ,  0.7071,  0.    ],
    [-0.6786, -0.    , -0.6786, -0.2811],
    [-0.6533,  0.2706, -0.6533, -0.2706],
    [-0.6533,  0.2706,  0.6533, -0.2706],
    [-0.6533,  0.6533, -0.2706, -0.2706],
    [-0.6533,  0.6533,  0.2706, -0.2706],
    [ 0.6786, -0.6786, -0.2811, -0.    ],
    [ 0.6786, -0.6786,  0.2811, -0.    ],
    [ 0.6786, -0.2811, -0.6786, -0.    ],
    [ 0.6786, -0.2811,  0.6786, -0.    ],
    [ 0.6786,  0.    , -0.6786,  0.2811],
    [ 0.7071,  0.    ,  0.7071, -0.    ],
])

pair3 = ('m', 'm')
n3 = np.array([
    [0, 0, 0, 1],
])
v3 = np.array([
    [0, -1, 0, 0],
    [0, 0, -1, 0],
    [0, 0, 1, 0],
    [0, 1, 0, 0],
])

pair4 = ('23', '23')
n4 = np.array([
    [5e-06, -0.707107,         0,  0.707107],
    [5e-06, -0.707107,  0.707107,         0],
    [5e-06,  0.707107,         0,  0.707107],
    [5e-06,  0.707107,  0.707107,         0],
    [  0.5,      -0.5,      -0.5,      -0.5],
    [  0.5,      -0.5,      -0.5,       0.5],
    [  0.5,      -0.5,       0.5,      -0.5],
    [  0.5,       0.5,      -0.5,      -0.5],
    [  0.5,       0.5,      -0.5,       0.5],
    [  0.5,       0.5,       0.5,      -0.5],
])
v4 = np.array([
    [       -1,            0, -7.07107e-06, -7.07107e-06],
    [-0.707109,  5.00002e-06,    -0.707104,            0],
    [ 0.707109,  5.00002e-06,            0,     0.707104],
    [ 0.866025,    -0.288679,     0.288673,     0.288673],
    [ 0.866025,     0.288679,     0.288673,     0.288673],
])

pair5 = ('4/m', '4/m')
n5 = np.array([
    [   5e-06, -1, 0,        0],
    [   5e-06,  0, 0,        1],
    [   5e-06,  0, 1,        0],
    [0.382683,  0, 0, -0.92388],
    [0.382683,  0, 0,  0.92388],
])
v5 = np.array([
    [      -1,      -5e-06,       5e-06,       5e-06],
    [       0,          -1,           0,           0],
    [       0,           0,           1,           0],
    [ 0.92388,  4.6194e-06, -4.6194e-06,    0.382683],
])

pair6 = ('2', '2')
n6 = np.array([
    [   5e-06,        -1,         0,         0],
    [0.707107,         0,         0, -0.707107],
    [0.707107,         0,         0,  0.707107],
])
v6 = np.array([
    [0, 0, -1, 0],
    [0, 0,  1, 0],
])

pair7 = ('mm2', 'mm2')
n7 = np.array([
    [   5e-06,        -1,        0,         0],
    [   5e-06,         0,        1,         0],
    [0.707107,         0,        0, -0.707107],
    [0.707107,         0,        0,  0.707107],
])
v7 = np.array([
    [-0.707107, -3.53553e-06,  3.53553e-06,     0.707107],
    [        0,           -1,            0,            0],
    [        0,            0,            1,            0],
    [ 0.707107,  3.53553e-06, -3.53553e-06,     0.707107],
])

pair8 = ('-4', '-4')
n8 = np.array([
    [   5e-06,        -1,        0,         0],
    [   5e-06,         0,        0,         1],
    [0.707107,         0,        0, -0.707107],
    [0.707107,         0,        0,  0.707107],
])
v8 = np.array([
    [0,  0, -1,  0],
    [0,  0,  1,  0],
])

pair9 = ('32', '32')
n9 = np.array([
    [   5e-06,        -1,         0,         0],
    [   5e-06,      -0.5,  0.866025,         0],
    [   5e-06,         0,         0,         1],
    [     0.5,         0,         0, -0.866025],
    [0.707107, -0.353553, -0.612372,         0],
    [0.707107,  0.353553, -0.612372,         0],
    [0.707107,  0.353553,  0.612372,         0],
    [0.707107,  0.707107,         0,         0],
])
v9 = np.array([
    [-1.    , -0.    ,  0.    ,  0.    ],
    [-0.6124,  0.    , -0.7071, -0.3536],
    [-0.6124,  0.6124, -0.3536, -0.3536],
    [-0.6124,  0.6124,  0.3536, -0.3536],
    [ 0.6547, -0.6547, -0.378 , -0.    ],
    [ 0.6547, -0.6547,  0.378 , -0.    ],
    [ 0.6547,  0.    ,  0.7559, -0.    ],
    [ 0.866 ,  0.    , -0.    ,  0.5   ],
])

pair10 = ('-42m', '-42m')
n10 = np.array([
    [   5e-06, -0.707107,  0.707107,         0],
    [   5e-06,         0,         0,         1],
    [   5e-06,  0.707107,  0.707107,         0],
    [0.707107, -0.707107,         0,         0],
    [0.707107,         0, -0.707107,         0],
    [0.707107,         0,         0, -0.707107],
    [0.707107,  0.707107,         0,         0],
])
v10 = np.array([
    [-1.    ,  0.    ,  0.    ,  0.    ],
    [-0.5774, -0.5774, -0.5774,  0.    ],
    [-0.5   ,  0.5   , -0.5   , -0.5   ],
    [ 0.5   ,  0.5   ,  0.5   ,  0.5   ],
    [ 0.5774, -0.5774,  0.5774, -0.    ],
    [ 0.7071,  0.    , -0.    ,  0.7071]
])


def idfn(pair):
    return '-'.join(pair)


@pytest.fixture
def misorientation_region(request):
    cs1, cs2 = request.param
    cs1, cs2 = Symmetry.from_symbol(cs1), Symmetry.from_symbol(cs2)
    return MisorientationRegion.from_symmetry(cs1, cs2)


@pytest.fixture
def transformation(request):
    return Rotation(request.param)


@pytest.mark.parametrize('misorientation_region, normals, vertices', [
    (pair1, n1, v1),
    (pair2, n2, v2),
    (pair3, n3, v3),
    (pair4, n4, v4),
    (pair5, n5, v5),
    (pair6, n6, v6),
    (pair7, n7, v7),
    (pair8, n8, v8),
    (pair9, n9, v9),
    # (pair10, n10, v10),
], indirect=['misorientation_region'], ids=idfn)
def test_misorientation_region(misorientation_region, normals, vertices):
    n = misorientation_region.normals.numerical_sort().data
    v = misorientation_region.vertices.numerical_sort().data
    print(v.round(4))
    print(vertices.round(4))
    assert n.shape == normals.shape
    assert np.allclose(n, normals, atol=1e-4)
    assert v.shape == vertices.shape
    assert np.allclose(v, vertices, atol=1e-4)


@pytest.mark.parametrize('misorientation_region, normals', [
    (('4/m', '4/m'), np.array([[0, 0, 1], [-1, 0, 0], [0, 1, 0]]))
], indirect=['misorientation_region'])
def test_axis_sector(misorientation_region, normals):
    a = misorientation_region.axis_sector()
    assert np.allclose(a.normals.data, normals)

@pytest.mark.parametrize('misorientation_region, transformation, expected', [
    (
        ('432', '6/m'),
        np.array([
            [ 0.311136,    0.45008,  -0.836593,  -0.027108],
            [-0.488432,  -0.831872,    0.17173,    0.19983],
            [  0.71382,   0.579594,   0.342329,   0.193241],
            [ 0.306028, -0.0462308,  -0.200888,   0.929437],
            [ 0.206322,  -0.161906,  0.0943291,   0.960375],
        ]),
        np.array([
            [-0.9496,  0.179 ,  0.2559,  0.0285],
            [ 0.9698, -0.082 ,  0.2294, -0.0121],
            [-0.9814,  0.1264,  0.0644, -0.1291],
            [-0.977 ,  0.0073, -0.206 ,  0.055 ],
            [-0.9811, -0.1808,  0.0492, -0.0493],
        ])
    ),
    (
        ('-43m', '2'),
        np.array([
            [
                [0.0202138,  -0.693622,   0.695109,  -0.187891],
                [ 0.894486,   -0.28834,   0.260252,   0.221413],
                [ 0.930623,   0.178531,  -0.184753,    0.26064],
            ],
            [
                [0.0045205,  -0.546164,  -0.151557,   0.823841],
                [ 0.870159,   0.479543,  -0.110899, -0.0237199],
                [ 0.842834,  -0.188322,  -0.470534,  -0.181004],
            ]
        ]),
        np.array([
            [
                [0.981981,   -0.118566,   -0.147152,   -0.001051],
                [0.894486,    -0.28834,    0.260252,    0.221413],
                [0.930623,   -0.178531,    0.184753,     0.26064],
            ],
            [
                [ 0.96874,   -0.110364,   -0.196348,    0.103971],
                [0.954384,   -0.276208,  -0.0616448,  -0.0951897],
                [0.928692, -0.00517472,    0.263256,   -0.261153],
            ]
        ])
    )
], indirect=['misorientation_region', 'transformation'])
def test_project(misorientation_region, transformation, expected):
    transformations_projected = misorientation_region.project(transformation)
    assert np.allclose(transformations_projected.data, expected, atol=4)
